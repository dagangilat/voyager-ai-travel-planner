import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    const base44 = createClientFromRequest(req);
    const user = await base44.auth.me();

    if (!user) {
        return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    try {
        const { amount, price, payment_method, transaction_id, user_email } = await req.json();

        // Validate input
        if (!amount || !price || !payment_method || !transaction_id) {
            return Response.json({ 
                error: 'Missing required fields' 
            }, { status: 400 });
        }

        // Create purchase history record
        const purchaseRecord = await base44.entities.PurchaseHistory.create({
            user_email: user_email || user.email,
            item_type: 'ai_credits',
            amount: amount,
            price: price,
            payment_method: payment_method,
            status: 'completed',
            transaction_id: transaction_id,
            purchase_date: new Date().toISOString()
        });

        // Add credits to user account
        const currentCredits = user.credits?.ai_generations_remaining || 0;
        await base44.auth.updateMe({
            credits: {
                ...(user.credits || {}),
                ai_generations_remaining: currentCredits + amount
            }
        });

        return Response.json({
            success: true,
            purchase: purchaseRecord,
            new_balance: currentCredits + amount
        });

    } catch (error) {
        console.error('Payment processing error:', error);
        return Response.json({ 
            error: error.message || 'Payment processing failed' 
        }, { status: 500 });
    }
});